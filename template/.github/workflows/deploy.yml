name: Deploy to VPS

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: deploy
    if: ${{ github.actor != 'dependabot[bot]' && (github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success') }}
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: '${{ secrets.VPS_HOST }}'
          username: root
          key: '${{ secrets.VPS_SSH_KEY }}'
          port: '${{ secrets.SSH_PORT }}'
          protocol: tcp4
          script: |
            # Navigate to project directory
            cd /root/${{ secrets.VPS_HOST }} || exit 1

            # Fetch and reset to master branch
            echo "Fetching latest changes from master..."
            git fetch origin master
            git checkout master
            git reset --hard origin/master

            # Navigate to docker directory
            cd docker

            # Rebuild services
            echo "Rebuilding services..."
            docker compose build

            # Stop and remove frontend and caddy only (dozzle keeps running)
            docker compose down frontend caddy

            # Remove frontend volume to force fresh build
            docker volume rm $(docker volume ls -q | grep frontend_dist) || true

            # Start services fresh
            docker compose up -d

            # Clean up unused images and containers
            docker system prune -f

            # Show running containers
            docker compose ps
